---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { emphasizeAuthor, formatDate, formatAuthorsHtml } from '../../utils/formatters';

const publications = await getCollection('publications');

// Sort all publications by date (newest first)
const sortedPublications = publications.sort((a, b) =>
  new Date(b.data.date).getTime() - new Date(a.data.date).getTime()
);

// Extract all unique tags/categories
const allTags = [...new Set(sortedPublications.flatMap(pub => pub.data.tags || []))].sort();
---

<BaseLayout title="Publications - Griffin Chure">
  <div class="container">
    <header class="page-header">
      <h1 class="mono-upper">Publications</h1>
      <br/>
      <p>Below is a list of my scientific publications. Clicking on each card
      will bring you to a page with an abstract, an embedded paper PDF, and a
      bunch of useful links. If you cannot access any of the material due to
      broken links or the disastrous capitalism of modern scientific publishing,
      please contact me and I'll get you the goods.</p>
    </header>

    {allTags.length > 0 && (
      <div class="tag-filter">
        <span class="filter-label mono-upper">Filter by category:</span>
        <div class="tag-buttons">
          <button class="tag-button active mono-upper" data-tag="all">All</button>
          {allTags.map(tag => (
            <button class="tag-button mono-upper" data-tag={tag}>{tag}</button>
          ))}
        </div>
      </div>
    )}

    <div class="publications-list">
      {sortedPublications.map((pub, index) => {
        const authorNames = formatAuthorsHtml(pub.data.authors);
        const pubNumber = sortedPublications.length - index;

        return (
          <div class="publication-item" data-tags={JSON.stringify(pub.data.tags || [])}>
            <a href={`/publications/${pub.slug}`} class="pub-link">
              <span class="pub-counter mono-upper">{pubNumber}</span>
              <time class="pub-date mono-upper">{formatDate(pub.data.date)}</time>
              <h3 class="pub-title mono-upper">{pub.data.title}</h3>
              <p class="pub-authors" set:html={emphasizeAuthor(authorNames)} />
              <p class="pub-meta">
                <span class="pub-journal mono-upper">{pub.data.journal}</span>
                {pub.data.DOI && (
                  <>
                    <span class="pub-separator">·</span>
                    <span class="pub-doi">{pub.data.DOI}</span>
                  </>
                )}
              </p>
              {pub.data.tags && pub.data.tags.length > 0 && (
                <div class="pub-tags">
                  {pub.data.tags.map(tag => (
                    <span class="pub-tag mono-upper">{tag}</span>
                  ))}
                </div>
              )}
            </a>
          </div>
        );
      })}
    </div>
  </div>
</BaseLayout>

<style>
  /* Tag filter */
  .tag-filter {
    margin-bottom: 2rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid var(--border-color);
  }

  .filter-label {
    font-size: 0.7rem;
    color: var(--text-tertiary);
    display: block;
    margin-bottom: 0.75rem;
    letter-spacing: 0.03em;
  }

  .tag-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .tag-button {
    padding: 0.35rem 0.75rem;
    font-size: 0.7rem;
    background: transparent;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.15s ease;
    letter-spacing: 0.03em;
  }

  .tag-button:hover {
    border-color: var(--text-tertiary);
    color: var(--text-primary);
  }

  .tag-button.active {
    background: var(--text-primary);
    border-color: var(--text-primary);
    color: var(--bg-primary);
  }

  .publications-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .publication-item {
    border-left: 2px solid var(--border-color);
    padding-left: 1rem;
    transition: border-color 0.15s ease;
  }

  .publication-item:hover {
    border-left-color: var(--text-primary);
  }

  .publication-item:hover .pub-counter {
    color: var(--text-primary);
  }

  .publication-item.hidden {
    display: none;
  }

  .pub-link {
    display: grid;
    grid-template-columns: 1.75rem 1fr;
    gap: 0.25rem;
    text-decoration: none;
    align-items: start;
  }

  .pub-counter {
    font-size: 0.75rem;
    color: var(--text-tertiary);
    letter-spacing: 0.03em;
    transition: color 0.15s ease;
  }

  .pub-content {
    display: flex;
    flex-direction: column;
  }

  .pub-date {
    font-size: 0.7rem;
    color: var(--text-tertiary);
    letter-spacing: 0.03em;
    display: block;
    margin-bottom: 0.1rem;
    grid-column: 2;
  }

  .pub-title {
    font-size: 1rem;
    font-weight: 400;
    margin-bottom: 0.1rem;
    color: var(--text-primary);
    line-height: 1.3;
    letter-spacing: 0.02em;
    grid-column: 2;
  }

  .pub-authors {
    font-size: 0.85rem;
    color: var(--text-secondary);
    font-weight: 400;
    font-family: 'Geist', sans-serif;
    margin-bottom: 0.1rem;
    line-height: 1.3;
    grid-column: 2;
  }

  .pub-authors :global(.emphasized-author) {
    font-weight: 600;
    text-decoration: underline;
    color: var(--text-primary);
  }

  .pub-meta {
    font-size: 0.7rem;
    color: var(--text-secondary);
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
    align-items: center;
    grid-column: 2;
    margin-bottom: 0;
  }

  .pub-separator {
    color: var(--text-tertiary);
  }

  .pub-journal {
    letter-spacing: 0.03em;
  }

  .pub-doi {
    font-size: 0.7rem;
    color: var(--text-tertiary);
    font-family: 'Geist Mono', monospace;
  }

  .pub-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 0;
    grid-column: 2;
  }

  .pub-tag {
    font-size: 0.65rem;
    color: var(--text-tertiary);
    letter-spacing: 0.03em;
  }

  .pub-tag:not(:last-child)::after {
    content: '·';
    margin-left: 0.5rem;
    color: var(--text-tertiary);
  }

  @media (max-width: 768px) {
    .tag-buttons {
      gap: 0.4rem;
    }

    .tag-button {
      padding: 0.3rem 0.6rem;
      font-size: 0.65rem;
    }

    .pub-title {
      font-size: 0.9rem;
    }
  }
</style>

<script>
  // Category filtering functionality
  const tagButtons = document.querySelectorAll('.tag-button');
  const pubItems = document.querySelectorAll('.publication-item');

  tagButtons.forEach(button => {
    button.addEventListener('click', () => {
      const selectedTag = button.getAttribute('data-tag');

      // Update active state
      tagButtons.forEach(btn => btn.classList.remove('active'));
      button.classList.add('active');

      // Filter publications
      pubItems.forEach(item => {
        if (selectedTag === 'all') {
          item.classList.remove('hidden');
        } else {
          const pubTags = JSON.parse(item.getAttribute('data-tags') || '[]');
          if (pubTags.includes(selectedTag)) {
            item.classList.remove('hidden');
          } else {
            item.classList.add('hidden');
          }
        }
      });
    });
  });
</script>
